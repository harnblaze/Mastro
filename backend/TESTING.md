# Тестирование бэкенда

Этот документ описывает систему тестирования для бэкенда приложения Mastro.

## Структура тестов

### Unit тесты (`src/**/*.spec.ts`)

- **AuthService** - тестирование авторизации через VK и JWT
- **VkService** - тестирование интеграции с VK API
- **BusinessService** - тестирование CRUD операций с бизнесом
- **BookingsService** - тестирование логики бронирования и проверки конфликтов
- **ServicesService** - тестирование управления услугами

### Интеграционные тесты (`test/api.integration.spec.ts`)

- Тестирование API эндпоинтов
- Проверка авторизации и RBAC
- Валидация данных и обработка ошибок
- Тестирование взаимодействия между модулями

### E2E тесты (`test/app.e2e-spec.ts`)

- Полные пользовательские сценарии
- Флоу записи клиента
- Управление бизнесом
- Обработка конфликтов времени

## Запуск тестов

### Подготовка окружения

```bash
# Установка зависимостей
npm install

# Подготовка тестовой базы данных
npm run test:prepare
```

### Запуск всех тестов

```bash
# Все тесты
npm run test:all

# Только unit тесты
npm run test:unit

# Только интеграционные тесты
npm run test:integration

# Только E2E тесты
npm run test:e2e

# Тесты с покрытием
npm run test:cov

# Тесты в режиме наблюдения
npm run test:watch
```

## Конфигурация

### Jest конфигурация (`test/jest.config.js`)

- Настройка для TypeScript
- Покрытие кода
- Таймауты и окружение
- Настройка путей

### Тестовая база данных

- Используется SQLite для тестов (`test.db`)
- Автоматическая очистка между тестами
- Изолированные тестовые данные

## Утилиты для тестирования

### TestUtils (`test/setup.ts`)

- `createTestApp()` - создание тестового приложения
- `cleanupDatabase()` - очистка базы данных
- `seedTestData()` - создание тестовых данных

### TestDataFactory (`test/fixtures.ts`)

- Создание тестовых данных
- Фикстуры для всех сущностей
- Полные сценарии тестирования

### TestAssertions (`test/fixtures.ts`)

- Утилиты для проверки данных
- Валидация структуры объектов
- Проверка форматов времени

## Основные тестовые сценарии

### 1. Авторизация

- ✅ VK OAuth авторизация
- ✅ JWT токены
- ✅ Регистрация пользователей
- ✅ Валидация токенов

### 2. Управление бизнесом

- ✅ Создание бизнеса
- ✅ Обновление информации
- ✅ Права доступа
- ✅ Рабочие часы

### 3. Управление услугами

- ✅ CRUD операции
- ✅ Валидация данных
- ✅ Связи с сотрудниками

### 4. Бронирование

- ✅ Создание записей
- ✅ Проверка конфликтов времени
- ✅ Расчет времени окончания
- ✅ Управление статусами
- ✅ Доступные слоты

### 5. Клиенты

- ✅ Создание клиентов
- ✅ История записей
- ✅ Поиск по телефону

### 6. Уведомления

- ✅ Создание уведомлений
- ✅ Шаблоны сообщений
- ✅ Отправка через разные каналы

## Покрытие кода

Цель покрытия: **80%+**

Текущее покрытие можно посмотреть командой:

```bash
npm run test:cov
```

Отчет сохраняется в папке `coverage/`.

## Отладка тестов

### Запуск с отладкой

```bash
npm run test:debug
```

### Логирование в тестах

```typescript
// Включить логи
process.env.NODE_ENV = 'test';
console.log('Debug info:', data);
```

### Проверка базы данных

```typescript
// Проверить состояние БД
const bookings = await prisma.booking.findMany();
console.log('Bookings:', bookings);
```

## Лучшие практики

### 1. Изоляция тестов

- Каждый тест должен быть независимым
- Очистка данных между тестами
- Использование моков для внешних сервисов

### 2. Именование тестов

```typescript
describe('BookingsService', () => {
  describe('create', () => {
    it('должен успешно создать запись с новым клиентом', async () => {
      // тест
    });

    it('должен выбросить ConflictException при конфликте времени', async () => {
      // тест
    });
  });
});
```

### 3. Использование фикстур

```typescript
// Хорошо
const booking = await TestDataFactory.createBooking({
  serviceId: testData.service.id,
  staffId: testData.staff.id,
  startTs: '2025-01-15T12:00:00Z',
});

// Плохо
const booking = await prisma.booking.create({
  data: {
    businessId: 'hardcoded-id',
    serviceId: 'hardcoded-service-id',
    // ...
  },
});
```

### 4. Проверка ошибок

```typescript
// Проверяем тип ошибки и сообщение
await expect(service.create(dto)).rejects.toThrow(ConflictException);

// Проверяем структуру ошибки
const error = await service.create(dto).catch((e) => e);
expect(error.code).toBe('SLOT_CONFLICT');
expect(error.message).toContain('занято');
```

## CI/CD

Тесты автоматически запускаются в CI/CD pipeline:

1. **Unit тесты** - быстрые, без внешних зависимостей
2. **Интеграционные тесты** - с тестовой БД
3. **E2E тесты** - полные сценарии

### GitHub Actions

```yaml
- name: Run tests
  run: |
    npm run test:prepare
    npm run test:all
```

## Мониторинг

### Метрики качества

- Покрытие кода: 80%+
- Время выполнения тестов: < 5 минут
- Успешность тестов: 100%

### Алерты

- Падение покрытия кода
- Увеличение времени выполнения
- Неуспешные тесты

## Расширение тестов

### Добавление новых тестов

1. Создать файл `*.spec.ts` в соответствующей папке
2. Использовать существующие утилиты и фикстуры
3. Следовать паттернам именования
4. Добавить в CI/CD pipeline

### Новые утилиты

1. Добавить в `test/fixtures.ts`
2. Экспортировать из модуля
3. Документировать использование
4. Добавить тесты для утилит

## Troubleshooting

### Частые проблемы

#### Тесты падают из-за БД

```bash
# Очистить тестовую БД
rm test.db
npm run test:prepare
```

#### Проблемы с авторизацией

```typescript
// Проверить токен
console.log('Auth token:', authToken);
```

#### Конфликты времени

```typescript
// Проверить существующие записи
const existing = await prisma.booking.findMany();
console.log('Existing bookings:', existing);
```

#### Моки не работают

```typescript
// Проверить настройку моков
expect(mockService.method).toHaveBeenCalledWith(expectedArgs);
```
